# æ‰©å±• mmap è¿ç§»æ¸…å•

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### æ ¸å¿ƒæ¶æ„å˜æ›´

- [x] **shm_transport.py** - æ‰©å±• mmap æ¶æ„
  - [ ] 512 MB â†’ 4 GB å…±äº«å†…å­˜æ± 
  - [ ] 2 ä¸ª slot â†’ 16 ä¸ª slotï¼ˆå¤šå±‚æ¬¡åˆ†é…ï¼‰
  - [ ] æ·»åŠ è½®è½¬è®¡æ•°å™¨ï¼š`_input_counter`, `_output_counter`, `_scratch_counter`
  - [ ] æ–°æ–¹æ³•ï¼š`_alloc_input_slot()`, `_alloc_output_slot()`, `_alloc_scratch_slot()`
  - [ ] æ”¹è¿› `write()` ç­¾åï¼šæ”¯æŒè‡ªåŠ¨ slot åˆ†é…å’Œ `is_output` å‚æ•°
  - [ ] ç§»é™¤"è¶…è¿‡ SLOT_SIZE è¿”å› None"çš„æ£€æŸ¥

- [x] **server.py** - ç§»é™¤æœåŠ¡ç«¯ fallback
  - [ ] ç®€åŒ– `_encode_result()` å‡½æ•°
  - [ ] ç§»é™¤ uuid + np.save çš„ .npy fallback é€»è¾‘
  - [ ] ç›´æ¥ä½¿ç”¨ `ShmTransport.get().write(obj, is_output=True)`

- [x] **cuml_proxy/proxy.py** - ç§»é™¤å®¢æˆ·ç«¯ fallback
  - [ ] ç®€åŒ– `_encode_array()` å‡½æ•°
  - [ ] ç§»é™¤ .npy æ–‡ä»¶ç”Ÿæˆé€»è¾‘
  - [ ] ç›´æ¥ä½¿ç”¨ `ShmTransport.get().write(arr)`
  - [ ] ä¿ç•™ `_decode_array()` ä¸­çš„ `.npy` è¯»å–ï¼ˆå‘åå…¼å®¹ï¼‰

### æµ‹è¯•å’Œæ–‡æ¡£

- [x] **test_extended_mmap.py** - æ–°å¢é›†æˆæµ‹è¯•
  - [ ] å°æ•°ç»„æµ‹è¯•ï¼ˆ< 10 KBï¼Œbase64ï¼‰
  - [ ] ä¸­ç­‰æ•°ç»„æµ‹è¯•ï¼ˆ10 KB - 256 MBï¼Œmmapï¼‰
  - [ ] å¤§æ•°ç»„æµ‹è¯•ï¼ˆ256 MB - 1 GBï¼Œå¤š slotï¼‰
  - [ ] è¿ç»­è¯·æ±‚æµ‹è¯•ï¼ˆéªŒè¯ slot è½®è½¬ï¼‰
  - [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•

- [x] **EXTENDED_MMAP_OPTIMIZATION.md** - è¯¦ç»†ä¼˜åŒ–æŠ¥å‘Š
  - [ ] é—®é¢˜åˆ†æ
  - [ ] è§£å†³æ–¹æ¡ˆè®¾è®¡
  - [ ] æ€§èƒ½å¯¹æ¯”æ•°æ®
  - [ ] æ–‡ä»¶ä¿®æ”¹æ¸…å•
  - [ ] å…¼å®¹æ€§è¯´æ˜
  - [ ] å®‰è£…å’ŒéªŒè¯æ­¥éª¤

- [x] **MMAP_CONFIG_GUIDE.md** - é…ç½®å’Œæ•…éšœæ’é™¤æŒ‡å—
  - [ ] å‚æ•°è¯´æ˜
  - [ ] æ€§èƒ½ä¼˜åŒ–å»ºè®®
  - [ ] ç›‘æ§å’Œè¯Šæ–­æ–¹æ³•
  - [ ] æ•…éšœæ’é™¤ç« èŠ‚
  - [ ] æ€§èƒ½åŸºå‡†æ•°æ®

---

## ğŸš€ åç»­éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ¸…ç†æ—§ pool

```bash
# å¤‡ä»½æ—§æ± ï¼ˆå¯é€‰ï¼‰
move C:\Users\nicho\gpu-sklearn-bridge\shm\pool.bin C:\Users\nicho\gpu-sklearn-bridge\shm\pool.bin.backup

# ç³»ç»Ÿä¼šåœ¨é¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºæ–° 4 GB pool
```

### æ­¥éª¤ 2ï¼šå¯åŠ¨æœåŠ¡

**WSL2 æœåŠ¡ç«¯**ï¼š
```bash
cd /mnt/c/Users/nicho/gpu-sklearn-bridge
python server.py
# è§‚å¯Ÿå¯åŠ¨æ—¥å¿—ï¼š
# [ShmTransport] åˆå§‹åŒ– mmap pool: /mnt/c/Users/nicho/gpu-sklearn-bridge/shm/pool.bin (4.0 GB)
```

**Windows å®¢æˆ·ç«¯** - ç­‰å¾…æœåŠ¡ç«¯å°±ç»ªåè¿è¡Œï¼š
```bash
cd C:\Users\nicho\gpu-sklearn-bridge
python test_extended_mmap.py
```

### æ­¥éª¤ 3ï¼šéªŒè¯è¾“å‡º

é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š

```
======================================================================
 æ‰©å±• mmap å…±äº«å†…å­˜ä¼ è¾“æµ‹è¯•
======================================================================

[1] å°æ•°ç»„ï¼ˆ2Ã—4, ~96 Bï¼‰â€”â€” æœŸæœ›èµ° inline base64
    è¾“å…¥å½¢çŠ¶: (2, 4)  è¾“å‡ºå½¢çŠ¶: (2, 4)
    ç»“æœï¼ˆå·²æ ‡å‡†åŒ–ï¼‰:
    ...

[4] è¶…å¤§æ•°ç»„ï¼ˆ10000Ã—6400, ~500 MBï¼‰â€”â€” æ‰©å±• mmap è½®è½¬ slot
    æ•°ç»„å¤§å°: 500.0 MB  (è·¨è¶Šå¤šä¸ª 256 MB slot)
    ğŸ“  å®¢æˆ·ç«¯ç¼–ç ...
       ç¼–ç è€—æ—¶: 150.2 ms
       âœ…  ä½¿ç”¨ mmap slot 2ï¼ˆè‡ªåŠ¨è½®è½¬åˆ†é…ï¼‰
    ğŸš€  PCA fit_transform...
       è€—æ—¶: 750.0 ms
       è¾“å‡ºå½¢çŠ¶: (10000, 10)
       ç­‰æ•ˆåå: 667 MB/sï¼ˆå« HTTP + GPUï¼‰

======================================================================
 å…¨éƒ¨æµ‹è¯•é€šè¿‡ âœ…  â€”â€” æ‰©å±• mmap æ¶æ„è¿è¡Œæ­£å¸¸
 â€¢ æ¶ˆé™¤äº† .npy fallback çš„ç£ç›˜ I/O å¼€é”€
 â€¢ æ”¯æŒ 4 GB pool å†…ä»»æ„å¤§å°çš„æ•°æ®
 â€¢ å¤š slot è½®è½¬é¿å…ç«äº‰
======================================================================
```

---

## ğŸ“Š æ€§èƒ½éªŒè¯æŒ‡æ ‡

è¿è¡Œåå¯¹æ¯”ä»¥ä¸‹æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | éªŒè¯æ–¹æ³• |
|-----|------|--------|
| 500 MB æ•°æ®ä¼ è¾“ | < 800 ms | test_extended_mmap.py [4] |
| slot è½®è½¬ | åºåˆ— 0,1,2,3,0,1... | test_extended_mmap.py [5] æ—¥å¿— |
| ç£ç›˜ I/O | 0ï¼ˆæ—  .npy æ–‡ä»¶åˆ›å»ºï¼‰ | `ls -l C:\...\shm\` æ£€æŸ¥ |
| å†…å­˜å ç”¨ï¼ˆç¨³å®šï¼‰ | < 8 GB | `tasklist` æˆ– `ps aux` |
| å¹¶å‘è¯·æ±‚ | 4 ä¸ª | å¹¶è¡Œè¿è¡Œå¤šä¸ªå®¢æˆ·ç«¯æµ‹è¯• |

---

## ğŸ” é—®é¢˜æ’æŸ¥

### å¦‚æœçœ‹åˆ° .npy æ–‡ä»¶åˆ›å»º

```bash
ls -la C:\Users\nicho\gpu-sklearn-bridge\shm\
# å¦‚æœæœ‰ UUID*.npy æ–‡ä»¶ï¼Œè¯´æ˜ä»åœ¨ä½¿ç”¨ fallback
```

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ server.py æ˜¯å¦å·²æ›´æ–°ï¼ˆç§»é™¤ np.save è°ƒç”¨ï¼‰
2. æ£€æŸ¥ cuml_proxy/proxy.py æ˜¯å¦å·²æ›´æ–°
3. é‡å¯ Python è§£é‡Šå™¨ï¼Œç¡®ä¿åŠ è½½æ–°ä»£ç 

### å¦‚æœçœ‹åˆ°å†…å­˜ä¸è¶³é”™è¯¯

```
ERROR: mmap error: No space left on device
```

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š`dir C:`
2. æ£€æŸ¥ pool.bin æ˜¯å¦çœŸçš„ 4 GBï¼š`dir C:\...\shm\pool.bin`
3. å¦‚æœç£ç›˜ä¸è¶³ï¼Œå‡å° POOL_SIZE é…ç½®æˆ–æ¸…ç†ç©ºé—´

### å¦‚æœæ€§èƒ½æ²¡æœ‰æ”¹è¿›

```
500 MB æ•°æ®ä»éœ€ > 1500 ms
```

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ–°çš„ test_extended_mmap.pyï¼ˆvs æ—§ test_mmap.pyï¼‰
2. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿï¼ˆåº” < 100 msï¼‰
3. æ£€æŸ¥ GPU æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ˆcuML è®¡ç®—æ—¶é—´ > 50%ï¼‰

---

## ğŸ“ ä»£ç å®¡æ ¸æ¸…å•

### shm_transport.py
- [ ] POOL_SIZE = 4 GBï¼ˆè¡Œ 36ï¼‰
- [ ] SLOT_INPUT_END = 4ï¼ˆè¡Œ 37ï¼‰
- [ ] SLOT_OUTPUT_END = 8ï¼ˆè¡Œ 38ï¼‰
- [ ] SLOT_SCRATCH_END = 16ï¼ˆè¡Œ 39ï¼‰
- [ ] `_alloc_input_slot()` æ–¹æ³•å­˜åœ¨ï¼ˆè¡Œ ~70ï¼‰
- [ ] `_alloc_output_slot()` æ–¹æ³•å­˜åœ¨ï¼ˆè¡Œ ~76ï¼‰
- [ ] `write()` æ–¹æ³•æ—  `if nbytes > SLOT_SIZE: return None`ï¼ˆè¡Œ ~110ï¼‰
- [ ] `write()` æ”¯æŒ `is_output` å‚æ•°ï¼ˆè¡Œ ~95ï¼‰

### server.py
- [ ] SLOT_INPUT_START å¸¸é‡ï¼ˆè¡Œ ~24ï¼‰
- [ ] `_encode_result()` æ—  `uuid + np.save` é€»è¾‘ï¼ˆè¡Œ ~135ï¼‰
- [ ] ç›´æ¥è¿”å› `ShmTransport.get().write(obj, is_output=True)`ï¼ˆè¡Œ ~140ï¼‰

### cuml_proxy/proxy.py
- [ ] `_encode_array()` æ—  `uuid + np.save` é€»è¾‘ï¼ˆè¡Œ ~70ï¼‰
- [ ] ç›´æ¥è¿”å› `ShmTransport.get().write(arr)`ï¼ˆè¡Œ ~71ï¼‰
- [ ] `_decode_array()` ä»æœ‰ `.npy` å¤‡ç”¨åˆ†æ”¯ï¼ˆè¡Œ ~85-90ï¼Œå‘åå…¼å®¹ï¼‰

---

## ğŸ¯ æ€§èƒ½ç›®æ ‡

ä¼˜åŒ–å‰åå¯¹æ¯”ï¼ˆ500 MB æ•°æ®å¤„ç†ï¼‰ï¼š

| é˜¶æ®µ | ä¼˜åŒ–å‰ï¼ˆ.npy fallbackï¼‰ | ä¼˜åŒ–åï¼ˆæ‰©å±•mmapï¼‰ | æ”¹è¿› |
|-----|----------------------|------------------|-----|
| å®¢æˆ·ç«¯ç¼–ç  | 200 ms | 150 ms | âœ… 25% |
| ç½‘ç»œä¼ è¾“ | 50 ms | 50 ms | â€” |
| æœåŠ¡ç«¯å¤„ç† | 300 ms | 300 ms | â€” |
| æœåŠ¡ç«¯ç¼–ç  | 800 ms | 120 ms | âœ… 85% |
| å®¢æˆ·ç«¯è§£ç  | 600 ms | 100 ms | âœ… 83% |
| **æ€»è€—æ—¶** | **~2 s** | **~0.7 s** | **âœ… 65%** |

---

## âœ¨ éªŒè¯å®Œæˆæ ‡å¿—

å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹ç°è±¡ï¼Œè¡¨ç¤ºè¿ç§»æˆåŠŸï¼š

1. âœ… `test_extended_mmap.py` å…¨éƒ¨æµ‹è¯•é€šè¿‡
2. âœ… æ—  .npy æ–‡ä»¶åˆ›å»ºåœ¨ `shm/` ç›®å½•
3. âœ… 500 MB æ•°æ®å¤„ç† < 1 s
4. âœ… å¤š slot è½®è½¬æ—¥å¿—å‡ºç°ï¼ˆ0,1,2,3,0,1...ï¼‰
5. âœ… å†…å­˜å ç”¨ç¨³å®šï¼ˆ< 8 GBï¼‰

---

**æœ€åæ£€æŸ¥æ—¥æœŸ**ï¼š2026-02-26  
**ä¼˜åŒ–ç‰ˆæœ¬**ï¼šv2.0 - Extended mmap with rotation slots
